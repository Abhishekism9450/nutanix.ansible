- debug:
    msg: Start testing OVA image creating

###########################################
- name: create_ova_image  while vm it's on
  ntnx_vms:
      state: present
      vm_uuid: "{{ vm.vm_uuid }}"
      operation: create_ova_image
      ova_name: integration_test_VMDK_ova
      ova_file_format: VMDK
      wait: true
  register: result
  ignore_errors: true

- name: Creation Status
  assert:
    that:
      - result.response is defined
      - result.response.status.state == 'COMPLETE'
    fail_msg: ' Unable to create VMDK ova_image while vm is on '
    success_msg: ' create VMDK ova_image successfully '

###########################################
- name: create_ova_image  while vm it's on with check mode
  ntnx_vms:
      state: present
      vm_uuid: "{{ vm.vm_uuid }}"
      operation: create_ova_image
      ova_name: integration_test_VMDK_ova
      ova_file_format: VMDK
      wait: true
  register: result
  ignore_errors: true
  check_mode: yes

- name: Creation Status
  assert:
    that:
      - result.response is defined
      - result.changed == false
      - result.failed == false
      - result.task_uuid != ""
    success_msg: ' Success: returned  as expected '
    fail_msg: ' Fail '

###########################################
- name: create QCOW2 ova_image  while vm it's off
  ntnx_vms:
      state: present
      vm_uuid: "{{ vm.vm_uuid }}"
      operation: create_ova_image
      ova_name: integration_test_QCOW2_ova
      ova_file_format: QCOW2
  register: result
  ignore_errors: true

- name: Creation Status
  assert:
    that:
      - result.response is defined
      - result.response.status.state == 'COMPLETE'
    fail_msg: ' Unable to create QCOW2 ova_image while vm is off '
    success_msg: ' create QCOW2 ova_image successfully '
